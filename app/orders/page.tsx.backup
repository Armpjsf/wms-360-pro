'use client';

import { getApiUrl } from '@/lib/config';


import { useState, useEffect, useCallback } from 'react';

import { FileText, ArrowRight, Printer, CheckCircle, Clock, Mail, RefreshCw, Play } from 'lucide-react';

import SignatureModal from '@/components/SignatureModal';

export default function OrderPage() {
  return (
    <div className="p-6 max-w-[1600px] mx-auto space-y-8">
      
      {/* Page Header */}
      <div className="flex items-center gap-4">
        <div className="p-3 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30">
            <FileText className="w-8 h-8 text-indigo-400" />
        </div>
        <div>
            <h1 className="text-2xl font-black text-white tracking-tight">
                ORDER & EMAIL CENTER
            </h1>
            <p className="text-slate-400 text-sm font-medium">
                ศูนย์จัดการคำสั่งซื้อและระบบดึงข้อมูลอัตโนมัติ
            </p>
        </div>
      </div>

      {/* Unified Dashboard Grid */}
      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
          
          {/* Section 1: Email Automation (Input Source) */}
          <div className="xl:col-span-1 space-y-6">
              <EmailAutomationCard />
          </div>

          {/* Section 2: Order Fulfillment (Processing) */}
          <div className="xl:col-span-2">
              <OrderManagementPanel />
          </div>

      </div>
    </div>
  );
}

// ----------------------------------------------------------------------
// Unified Component: Email Automation Card
// ----------------------------------------------------------------------
function EmailAutomationCard() {
    const [scanning, setScanning] = useState(false);
    const [results, setResults] = useState<any[]>([]);
    const [statusMsg, setStatusMsg] = useState("พร้อมทำงาน");

    const handleScan = async () => {
        setScanning(true);
        setStatusMsg("ติดต่อ Gmail API...");
        setResults([]);

        // Use .catch() to suppress browser console error
        const res = await fetch(getApiUrl('/api/email/scan'), { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        }).catch(err => {
            // Return a fake response for network errors
            return { ok: false, json: async () => ({ error: 'Network error' }) } as Response;
        });

        try {
            const data = await res.json();
            
            // Check if API returned success
            if (data.success) {
                setResults(data.results || []);
                setStatusMsg(`เสร็จสิ้น! ประมวลผล ${data.processed || 0} รายการ`);
                return;
            }
            
            // If network error, check if Roll Tag was actually updated
            if (data.error === 'Network error') {
                // Wait a bit and check if Roll Tag has new data
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                try {
                    // Refresh status to see if Roll Tag was updated
                    const statusRes = await fetch(getApiUrl('/api/orders/status'));
                    const statusData = await statusRes.json();
                    
                    if (statusData.pending && statusData.pending.length > 0) {
                        // Success! Roll Tag was updated despite network error
                        setStatusMsg(`เสร็จสิ้น! พบ ${statusData.pending.length} Roll Tag`);
                        return;
                    }
                } catch (e) {
                    // Ignore status check error
                }
                
                setStatusMsg('Error: ไม่สามารถเชื่อมต่อ API ได้ (ตรวจสอบ Server)');
            } else if (data.error) {
                // API returned error
                if (data.error.includes('Gmail')) {
                    setStatusMsg('Error: Gmail API ไม่พร้อม - ต้อง Setup OAuth');
                } else {
                    setStatusMsg(`Error: ${data.error}`);
                }
            } else {
                setStatusMsg('Error: Scan failed');
            }

        } catch (error: any) {
            console.error('Email Scan Error:', error);
            setStatusMsg(`Error: ${error.message}`);
        } finally {
            setScanning(false);
        }
    };

    return (
        <div className="bg-gray-950/50 border border-white/10 rounded-3xl p-6 flex flex-col h-full backdrop-blur-xl">
            <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <Mail className="w-5 h-5 text-purple-400" />
                Email Automation
            </h2>

            <div className="bg-purple-900/10 border border-purple-500/20 rounded-2xl p-6 text-center space-y-4 mb-6">
                 <div className={`w-16 h-16 mx-auto rounded-full flex items-center justify-center transition-all ${scanning ? 'bg-purple-500/20 scale-110' : 'bg-slate-800'}`}>
                    {scanning ? <RefreshCw className="w-8 h-8 text-purple-400 animate-spin" /> : <Mail className="w-8 h-8 text-slate-400" />}
                 </div>
                 
                 <div>
                    <h3 className="font-bold text-slate-200">{scanning ? "กำลังสแกน..." : "Import Orders"}</h3>
                    <p className="text-xs text-slate-400 mt-1">ดึงไฟล์ Excel จากอีเมลเข้า Roll Tag</p>
                 </div>

                 <button
                    onClick={handleScan}
                    disabled={scanning}
                    className="w-full bg-white text-purple-900 hover:bg-purple-50 px-4 py-3 rounded-xl font-bold shadow-lg transition-all transform active:scale-95 disabled:opacity-50 disabled:transform-none text-sm"
                 >
                    {scanning ? 'Processing...' : 'Start Scan'}
                 </button>
                 
                 {/* Status Message */}
                 {statusMsg && statusMsg !== "พร้อมทำงาน" && (
                     <div className={`text-xs p-2 rounded-lg ${statusMsg.includes('Error') ? 'bg-red-500/10 text-red-300 border border-red-500/20' : 'bg-green-500/10 text-green-300 border border-green-500/20'}`}>
                         {statusMsg}
                     </div>
                 )}
            </div>

        </div>
    );
}

// ----------------------------------------------------------------------
// Unified Component: Order Management Panel
// ----------------------------------------------------------------------
function OrderManagementPanel() {
  const [status, setStatus] = useState<any>({ pending: [], activeForm: null, waiting: [] });
  const [loading, setLoading] = useState(true);
  const [processing, setProcessing] = useState(false);
  const [showSigModal, setShowSigModal] = useState(false);
  const [signatureData, setSignatureData] = useState<string | null>(null);

  const [currentJobId, setCurrentJobId] = useState<string|null>(null);
  const [error, setError] = useState<string | null>(null);
  const [debugInfo, setDebugInfo] = useState<string>("");

  // Fetch status function (Moved out of useEffect)
  const fetchStatus = useCallback(async () => {
     console.log('[fetchStatus] Starting fetch...');
     try {
       // 1. Get Roll Tag / Job Status
       // Cache Busting: Add timestamp to force fresh request
       const url = getApiUrl(`/api/orders/status?t=${Date.now()}`); 
       setDebugInfo(url);
       console.log('[fetchStatus] Fetching from:', url);
       
       const res = await fetch(url, {
           cache: 'no-store'
       });
       if (!res.ok) {
           const errTxt = await res.text().catch(() => "Unknown");
           console.warn(`[fetchStatus] Status poll failed: ${res.status} ${errTxt}`);
           setError(`API Error ${res.status}: ${errTxt}`);
           return; 
       }

       const data = await res.json();
       console.log('[fetchStatus] Received data:', {
           hasPending: !!data.pending,
           pendingCount: data.pending?.length || 0,
           hasActiveForm: !!data.activeForm,
           activeFormDocNum: data.activeForm?.docNum,
           hasWaiting: !!data.waiting,
           waitingCount: data.waiting?.length || 0
       });
       
       if (data.error) {
           console.warn("[fetchStatus] Status API error:", data.error);
           setError(data.error);
           return;
       }
       
       // IMPORTANT: Only update state if we have meaningful data
       // This prevents flickering when API returns empty results during processing
       const hasData = (data.pending && data.pending.length > 0) || 
                       data.activeForm || 
                       (data.waiting && data.waiting.length > 0);
       
       if (hasData) {
           console.log('[fetchStatus] Setting status state with data');
           setStatus(data);
           setError(null);
       } else {
           console.log('[fetchStatus] Skipping state update - no meaningful data (preventing flicker)');
           // Keep existing state - don't clear it
       }

       // 2. Check for Synced Signature (only if no local signature yet and we have a docNum)
       const currentDoc = data.activeForm?.docNum;
       if (currentDoc && !signatureData) {
            const sigRes = await fetch(getApiUrl(`/api/orders/signature?docNum=${currentDoc}`));
            if (sigRes.ok) {
                const sigData = await sigRes.json();
                if (sigData.hasSignature) {
                    setSignatureData(sigData.signature);
                }
            }
       }
     } catch(err) { 
         console.error('[fetchStatus] Error:', err); 
     } finally { 
         setLoading(false); 
         console.log('[fetchStatus] Completed');
     }
  }, [signatureData]); // Add signatureData as dependency


  // Initial load and polling
  useEffect(() => {
    fetchStatus();
    // Poll slower (5s) to prevent rate limiting and flickering
    const interval = setInterval(fetchStatus, 5000);
    return () => clearInterval(interval);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // Empty dependency - only run once on mount
 

  // --- Strict Job Change Detection & Auto-Open ---
  useEffect(() => {
      const newId = status.activeForm?.docNum;
      
      // Only act if there is a valid NEW ID and it's different from current
      // This ignores 'null' or 'undefined' flickers
      if (newId && newId !== currentJobId) {
          
          // 1. Clear State for New Job
          setSignatureData(null);
          setCurrentJobId(newId);

          // 2. Auto-Open Modal (Mobile Build Only - for warehouse staff)
          const isMobileBuild = process.env.NEXT_PUBLIC_MOBILE_BUILD === 'true';
          if (isMobileBuild) {
              setShowSigModal(true);
          }
      }
  }, [status.activeForm?.docNum, currentJobId]);


  const handleFinalizeForm = async () => {
      if (!status.activeForm) return;

      if (!signatureData) {
          if (!confirm("No signature added. Proceed without signature?")) return;
      }

      setProcessing(true);
      try {
          const body = {
              signature: signatureData 
          };

          const res = await fetch(getApiUrl('/api/orders/finalize'), { 
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
          });
          const data = await res.json();
          
          if (res.ok) {
              window.open(data.pdfLink, '_blank');
              setSignatureData(null); // Clear local signature
              // Ideally we would clear server too, but since strictly tied to docNum, 
              // we can leave it to expire or explicitly clear. 
              // Let's explicitly clear for hygiene.
              await fetch(getApiUrl('/api/orders/signature'), { 
                  method: 'POST', 
                  body: JSON.stringify({ signature: null, docNum: status.activeForm.docNum }) 
              });
              await fetchStatus();
          } else {
              alert(`Error: ${data.error}`);
          }
      } catch (err: any) {
          alert("Failed: " + err.message);
      } finally {
          setProcessing(false);
      }
  };

  // ... (Other handlers remain same) ...
  const handleProcessRollTag = async (tagId: string) => {
    if (confirm(`Confirm processing ${tagId}?\nThis will create a new Active Job and clear the Roll Tag.`)) {
        setProcessing(true);
        try {
            const res = await fetch(getApiUrl('/api/orders/process'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tagId })
            });
            const data = await res.json();
            
            if (res.ok) {
                await fetchStatus(); 
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (err: any) {
            alert("Failed to process: " + err.message);
        } finally {
            setProcessing(false);
        }
    }
  };

  const handlePrintRollTag = (task: any) => {
      const url = getApiUrl(`/api/print/roll-tag?tagId=${task.id}`);
      window.open(url, '_blank');
  };

  const handleCopyLineText = async () => {
    try {
        const res = await fetch(getApiUrl('/api/orders/line-text'));
        const data = await res.json();
        if (data.text) {
            await navigator.clipboard.writeText(data.text);
            alert("Text copied to clipboard!");
        } else {
            alert("No text generated.");
        }
    } catch (e) {
        alert("Failed to copy text");
    }
  };

  const handleArchiveForm = async () => {
    if (!confirm("Save this job as 'Waiting for Customer' and clear form?")) return;
    
    setProcessing(true);
    try {
        const res = await fetch(getApiUrl('/api/orders/archive'), { method: 'POST' });
        if (res.ok) {
            await fetchStatus(); 
        } else {
            const d = await res.json();
            alert("Error: " + d.error);
        }
    } catch (e: any) {
        alert("Failed: " + e.message);
    } finally {
        setProcessing(false);
    }
  };

  const handleRecallJob = async (docNum: string) => {
      if (!confirm(`Recall job ${docNum} to Active Form? (Current form will be auto-saved)`)) return;
      setProcessing(true);
      try {
          const res = await fetch(getApiUrl('/api/orders/recall'), { 
            method: 'POST',
            body: JSON.stringify({ docNum })
          });
          if (res.ok) {
              await fetchStatus();
          } else {
              const d = await res.json();
              alert(`Error recalling job: ${d.error}`);
          }
      } catch (e) {
          alert("Failed");
      } finally {
          setProcessing(false);
      }
  };



    return (
      <div className="flex flex-col-reverse md:grid md:grid-cols-2 gap-6 h-full pb-6">
        
        {/* Left Column: Pending Tasks (Bottom on Mobile) */}
        <div className="flex flex-col gap-6">
            <div className="bg-gray-950/50 border border-white/10 rounded-3xl p-6 backdrop-blur-xl flex flex-col flex-1 min-h-[400px]">
                <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <Clock className="w-5 h-5 text-orange-400" />
                    Pending Orders <span className="text-xs bg-slate-800 text-slate-300 px-2 py-0.5 rounded-full">{status.pending?.length || 0}</span>
                </h2>
                
                {error && (
                    <div className="bg-red-900/50 p-3 rounded-xl mb-4 text-red-200 text-xs break-all border border-red-500/50 flex flex-col gap-2">
                        <strong>Connection Error:</strong>
                        <span>{error}</span>
                        <span className="font-mono bg-black/30 p-1 rounded">{debugInfo}</span>
                    </div>
                )}
                
                <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                    {loading ? (
                        <div className="animate-pulse space-y-3">
                            {[1,2].map(i => <div key={i} className="h-20 bg-slate-800/50 rounded-xl"></div>)}
                        </div>
                    ) : status.pending?.length === 0 ? (
                        <div className="h-40 flex flex-col items-center justify-center text-slate-500 border border-dashed border-slate-800 rounded-xl">
                            <CheckCircle className="w-8 h-8 mb-2 opacity-20" />
                            <span className="text-sm">No new orders</span>
                        </div>
                    ) : (
                        status.pending?.map((task: any) => (
                            <div key={task.id} className="group bg-slate-900/80 border border-slate-700/50 hover:border-blue-500/50 p-4 rounded-xl transition-all cursor-default">
                                <div className="flex justify-between items-start mb-3">
                                    <div>
                                        <div className="text-[10px] font-bold text-orange-400 uppercase tracking-widest bg-orange-950/30 px-2 py-0.5 rounded w-fit mb-1">{task.name}</div>
                                        <h3 className="font-bold text-slate-200">{task.customer || "Unknown Customer"}</h3>
                                        <div className="text-xs text-slate-500 mt-1">{task.items?.length || 0} items</div>
                                    </div>
                                    <div className="text-xs text-slate-500 font-mono">
                                        {new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => handlePrintRollTag(task)}
                                        className="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Printer className="w-3 h-3" /> Print
                                    </button>
                                    <button 
                                        onClick={() => handleProcessRollTag(task.id)}
                                        disabled={processing}
                                        className="flex-1 bg-blue-900/50 hover:bg-blue-600 hover:text-white text-blue-200 py-2 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Process <ArrowRight className="w-3 h-3" />
                                    </button>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>
        </div>

        {/* Right Column: Active & Waiting (Top on Mobile) */}
        <div className="flex flex-col gap-6">

            {/* Active Form */}
            <div className="bg-gray-950/50 border border-white/10 rounded-3xl p-6 backdrop-blur-xl flex flex-col min-h-[350px]">
                <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <FileText className="w-5 h-5 text-blue-400" />
                    Active Job
                    {status.activeForm && (
                        <button 
                            onClick={handleArchiveForm}
                            disabled={processing}
                            className="ml-auto text-[10px] bg-slate-800 hover:bg-yellow-900/50 text-slate-300 hover:text-yellow-200 px-3 py-1 rounded-full transition-colors border border-slate-700"
                        >
                            ⏸ Auto-Save
                        </button>
                    )}
                </h2>

                {!status.activeForm ? (
                    <div className="flex-1 flex flex-col items-center justify-center text-slate-500 border border-dashed border-slate-800 rounded-xl">
                        <div className="w-16 h-16 rounded-full bg-slate-900 flex items-center justify-center mb-3 text-slate-700">
                            <Play className="w-6 h-6 ml-1" />
                        </div>
                        <span>Ready for new job</span>
                    </div>
                ) : (
                    <div className="flex-1 flex flex-col justify-between bg-gradient-to-br from-blue-900/10 to-slate-900/50 border border-blue-500/20 rounded-2xl p-6 relative overflow-hidden group">
                        <div className="absolute top-0 right-0 p-32 bg-blue-500/5 blur-3xl rounded-full -translate-y-1/2 translate-x-1/2 pointer-events-none group-hover:bg-blue-500/10 transition-colors duration-500"></div>
                        
                        <div className="relative z-10">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <div className="text-xs text-blue-300 font-medium mb-1">Document No.</div>
                                    <div className="text-3xl font-black text-white tracking-tight font-mono">{status.activeForm.docNum}</div>
                                </div>
                                <div className="bg-green-500 text-black px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider animate-pulse">
                                    OPEN
                                </div>
                            </div>

                            <div className="space-y-2 mb-6">
                                <div className="flex justify-between text-sm text-slate-400 border-b border-white/5 pb-2">
                                    <span>Customer</span>
                                    <span className="text-white font-mono">{status.activeForm.customer}</span>
                                </div>
                                <div className="flex justify-between text-sm text-slate-400 border-b border-white/5 pb-2">
                                    <span>Ref Date</span>
                                    <span className="text-white font-mono">{status.activeForm.refDate}</span>
                                </div>
                            </div>

                            
                            {/* Action Buttons */}
                            <div className="grid grid-cols-3 gap-3 mb-4">
                                <button
                                    onClick={handleCopyLineText}
                                    className="bg-slate-800 hover:bg-slate-700 text-slate-200 py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-colors border border-slate-700"
                                >
                                    <CheckCircle className="w-3 h-3 text-green-400" />
                                    Copy LINE Msg
                                </button>
                                <button
                                    onClick={() => setShowSigModal(true)}
                                    className={`py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-colors border ${
                                        signatureData ? 'bg-green-900/50 border-green-500/50 text-green-200' : 'bg-slate-800 hover:bg-slate-700 text-slate-200 border-slate-700'
                                    }`}
                                >
                                    {signatureData ? <CheckCircle className="w-3 h-3" /> : '✍️'} 
                                    {signatureData ? 'Signed' : 'Add Signature'}
                                </button>
                            </div>
                        </div>

                        <div className="relative z-10 pt-4 border-t border-white/5">
                            <button 
                                onClick={handleFinalizeForm}
                                disabled={processing}
                                className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-emerald-900/20 flex items-center justify-center gap-3 transition-all transform hover:-translate-y-0.5"
                            >
                                {processing ? 'Generating...' : (
                                    <>
                                        <Printer className="w-5 h-5" />
                                        Finalize & Print PDF
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                )}
            </div>

            {/* Waiting List */}
            <div className="bg-gray-950/50 border border-white/10 rounded-3xl p-6 backdrop-blur-xl flex flex-col flex-1 min-h-[250px]">
                 <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <Clock className="w-5 h-5 text-yellow-400" />
                    Waiting for Pickup <span className="text-xs bg-slate-800 text-slate-300 px-2 py-0.5 rounded-full">{status.waiting?.length || 0}</span>
                </h2>
                <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                     {status.waiting?.length === 0 ? (
                        <div className="h-full flex flex-col items-center justify-center text-slate-600">
                             <span className="text-sm">No waiting jobs</span>
                        </div>
                     ) : (
                         status.waiting?.map((job: any) => (
                             <div key={job.id} className="bg-slate-900/50 border border-slate-800 p-3 rounded-xl flex justify-between items-center group hover:bg-slate-800 transition-colors">
                                 <div>
                                     <div className="font-mono text-xs text-yellow-500/80">{job.id}</div>
                                     <div className="font-bold text-slate-300 text-sm">{job.customer}</div>
                                     {job.orders && job.orders.length > 0 && (
                                        <div className="text-[10px] text-slate-500 mt-0.5 max-w-[150px] truncate">
                                            Orders: {job.orders.join(', ')}
                                        </div>
                                     )}
                                 </div>
                                 <button 
                                     onClick={() => handleRecallJob(job.id)}
                                     disabled={processing}
                                     className="bg-slate-800 hover:bg-blue-600 text-slate-400 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all border border-slate-700"
                                 >
                                     Recall
                                 </button>
                             </div>
                         ))
                     )}
                </div>
            </div>

        </div>

        {/* Shared Signature Modal (Mobile Optimized) */}
        <SignatureModal 
            isOpen={showSigModal}
            onClose={() => setShowSigModal(false)}
            onSave={async (data) => {
                setSignatureData(data);
                setShowSigModal(false);
                
                // Upload to Server for Sync
                try {
                    const docNum = status.activeForm?.docNum;
                    if (docNum) {
                        await fetch(getApiUrl('/api/orders/signature'), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ signature: data, docNum })
                        });
                    }
                } catch (e) {
                     console.error("Sync failed", e);
                }
            }}
            docNum={status.activeForm?.docNum || "Unknown"}
        />

      </div>
  );
}
